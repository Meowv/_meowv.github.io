<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="当然我在瞎扯啊"><title>ASP.NET Core 中的应用程序启动 | 当然我在瞎扯</title><link rel="stylesheet" type="text/css" href="/v2/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/v2/favicon.ico"><link rel="apple-touch-icon" href="/v2/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/v2/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/v2/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ASP.NET Core 中的应用程序启动</h1><a id="logo" href="/v2/.">当然我在瞎扯</a><p class="description">生命不息，奋斗不止</p></div><div id="nav-menu"><a href="/v2/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/v2/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/v2/about/"><i class="fa fa-user"> 关于我</i></a><a href="/v2/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ASP.NET Core 中的应用程序启动</h1><div class="post-meta">Jul 3, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h1 id="ASP-NET-Core-中的应用程序启动"><a href="#ASP-NET-Core-中的应用程序启动" class="headerlink" title="ASP.NET Core 中的应用程序启动"></a><a name="application-startup-in-aspnet-core"></a>ASP.NET Core 中的应用程序启动</h1><p><code>Startup</code> 类配置服务和应用的请求管道。</p>
<h2 id="Startup-类"><a href="#Startup-类" class="headerlink" title="Startup 类"></a><a name="the-startup-class"></a>Startup 类</h2><p>ASP.NET Core 应用使用 <code>Startup</code> 类，按照约定命名为 <code>Startup</code>。 <code>Startup</code> 类：</p>
<ul>
<li>可选择性地包括 ConfigureServices 方法以配置应用的服务。</li>
<li>必须包括 Configure 方法以创建应用的请求处理管道。</li>
</ul>
<a id="more"></a>
<p>当应用启动时，运行时调用 <code>ConfigureServices</code> 和 <code>Configure</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Use this method to add services to the container.</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">    &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Use this method to configure the HTTP request pipeline.</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app</span>)</span></div><div class="line">    &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 WebHostBuilderExtensions、UseStartup&lt;TStartup&gt; 方法指定 <code>Startup</code> 类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></div><div class="line">    &#123;</div><div class="line">        BuildWebHost(args).Run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHost <span class="title">BuildWebHost</span>(<span class="params"><span class="keyword">string</span>[] args</span>) </span>=&gt;</div><div class="line">        WebHost.CreateDefaultBuilder(args)</div><div class="line">            .UseStartup&lt;Startup&gt;()</div><div class="line">            .Build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Startup</code> 类构造函数接受由主机定义的依赖关系。 在 <code>Startup</code> 类中注入依赖关系的常见用途为注入：</p>
<ul>
<li>IHostingEnvironment 以按环境配置服务。</li>
<li>IConfiguration 以在启动过程中配置应用。</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IHostingEnvironment env, IConfiguration config</span>)</span></div><div class="line">    &#123;</div><div class="line">        HostingEnvironment = env;</div><div class="line">        Configuration = config;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> IHostingEnvironment HostingEnvironment &#123; <span class="keyword">get</span>; &#125;</div><div class="line">    <span class="keyword">public</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (HostingEnvironment.IsDevelopment())</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Development configuration</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Staging/Production configuration</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Configuration is available during startup. Examples:</span></div><div class="line">        <span class="comment">// Configuration["key"]</span></div><div class="line">        <span class="comment">// Configuration["subsection:suboption1"]</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注入 <code>IHostingEnvironment</code> 的替代方法是使用基于约定的方法。 该应用可以为不同的环境（例如 <code>StartupDevelopment</code>）定义单独的 <code>Startup</code> 类，并在运行时选择适当的 startup 类。 优先考虑名称后缀与当前环境相匹配的类。 如果应用在开发环境中运行并包含 <code>Startup</code> 类和 <code>StartupDevelopment</code> 类，则使用 <code>StartupDevelopment</code> 类。</p>
<h2 id="ConfigureServices-方法"><a href="#ConfigureServices-方法" class="headerlink" title="ConfigureServices 方法"></a><a name="the-configureservices-method"></a>ConfigureServices 方法</h2><p>ConfigureServices 方法是：</p>
<ul>
<li>Optional</li>
<li>在 <code>Configure</code> 方法配置应用服务之前，由 Web 主机调用。</li>
<li>其中按常规设置配置选项。</li>
</ul>
<p>将服务添加到服务容器，使其在应用和 <code>Configure</code> 方法中可用。 这些服务通过依赖关系注入或 IApplicationBuilder.ApplicationServices 解析。</p>
<p>Web 主机可能会在调用 <code>Startup</code> 方法之前配置某些服务。</p>
<p>对于需要大量设置的功能，IServiceCollection 上有 <code>Add[Service]</code> 扩展方法。 典型 Web 应用将为实体框架、标识和 MVC 注册服务：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Add framework services.</span></div><div class="line">    services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;</div><div class="line">        options.UseSqlServer(Configuration.GetConnectionString(<span class="string">"DefaultConnection"</span>)));</div><div class="line"></div><div class="line">    services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;()</div><div class="line">        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()</div><div class="line">        .AddDefaultTokenProviders();</div><div class="line"></div><div class="line">    services.AddMvc();</div><div class="line"></div><div class="line">    <span class="comment">// Add application services.</span></div><div class="line">    services.AddTransient&lt;IEmailSender, AuthMessageSender&gt;();</div><div class="line">    services.AddTransient&lt;ISmsSender, AuthMessageSender&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ASP-NET-Core-MVC-的-SetCompatibilityVersion"><a href="#ASP-NET-Core-MVC-的-SetCompatibilityVersion" class="headerlink" title="ASP.NET Core MVC 的 SetCompatibilityVersion"></a><a name="setcompatibilityversion-for-aspnet-core-mvc"></a>ASP.NET Core MVC 的 SetCompatibilityVersion</h3><p><code>SetCompatibilityVersion</code> 方法允许应用选择加入或退出 ASP.NET MVC Core 2.1+ 中引入的潜在中断行为变更。 这些潜在的中断行为变更通常取决于 MVC 子系统的行为方式以及运行时调用“代码”的方式。 通过选择加入，你将获取最新的行为以及 ASP.NET Core 的长期行为。</p>
<p>以下代码将兼容模式设置为 ASP.NET Core 2.1：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">&#123;</div><div class="line">    services.AddMvc()</div><div class="line">            .SetCompatibilityVersion(CompatibilityVersion.Version_2_1);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用 <code>SetCompatibilityVersion(CompatibilityVersion.Version_2_0)</code> 的应用程序会被阻止进行 ASP.NET Core 2.1 MVC 和更高的 2.x 版本中引入的潜在中断行为变更。 该阻止操作：</p>
<ul>
<li>不适用于所有 2.1 和更高版本的更改，它的目标是潜在地中断 MVC 子系统中的 ASP.NET Core 运行时行为变更。</li>
<li>不会扩展到下一个主要版本。</li>
</ul>
<p>不调用 <code>SetCompatibilityVersion</code> 的 ASP.NET Core 2.1 和更高 2.x 版本的应用程序的默认兼容性是 2.0 兼容性。 即，未调用 <code>SetCompatibilityVersion</code> 与调用 <code>SetCompatibilityVersion(CompatibilityVersion.Version_2_0)</code> 相同。</p>
<p>以下代码将兼容模式设置为 ASP.NET Core 2.1（以下行为除外）：</p>
<ul>
<li><a href="https://github.com/aspnet/Mvc/blob/dev/src/Microsoft.AspNetCore.Mvc.Core/MvcOptions.cs" target="_blank" rel="external">AllowCombiningAuthorizeFilters</a></li>
<li><a href="https://github.com/aspnet/Mvc/blob/dev/src/Microsoft.AspNetCore.Mvc.Core/MvcOptions.cs" target="_blank" rel="external">InputFormatterExceptionPolicy</a></li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">&#123;</div><div class="line">    services.AddMvc()</div><div class="line">     <span class="comment">// Include the 2.1 behaviors</span></div><div class="line">     .SetCompatibilityVersion(CompatibilityVersion.Version_2_1)</div><div class="line">     <span class="comment">// Except for the following.</span></div><div class="line">     .AddMvcOptions(options =&gt;</div><div class="line">     &#123;</div><div class="line">       <span class="comment">// Don't combine authorize filters (keep 2.0 behavior).</span></div><div class="line">       options.AllowCombiningAuthorizeFilters = <span class="literal">false</span>;</div><div class="line">       <span class="comment">// All exceptions thrown by an IInputFormatter will be treated</span></div><div class="line">       <span class="comment">// as model state errors (keep 2.0 behavior).</span></div><div class="line">       options.InputFormatterExceptionPolicy =</div><div class="line">                      InputFormatterExceptionPolicy.AllExceptions;</div><div class="line">     &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于遇到中断行为变更的应用，请使用适当的兼容性开关：</p>
<ul>
<li>允许使用最新版本并选择退出特定的中断行为变更。</li>
<li>请用些时间更新应用，以便其适用于最新更改。</li>
</ul>
<p><a href="https://github.com/aspnet/Mvc/blob/dev/src/Microsoft.AspNetCore.Mvc.Core/MvcOptions.cs" target="_blank" rel="external">MvcOptions</a> 类源注释充分地阐述了更改的内容以及为什么更改对大多数用户来说是一种改进。</p>
<p>将来会推出 <a href="https://github.com/aspnet/Home/wiki/Roadmap" target="_blank" rel="external">ASP.NET Core 3.0 版本</a>。 在 3.0 版本中，将删除兼容性开关支持的旧行为。</p>
<h2 id="Startup-中可用的服务"><a href="#Startup-中可用的服务" class="headerlink" title="Startup 中可用的服务"></a><a name="services-available-in-startup"></a>Startup 中可用的服务</h2><p>Web 主机提供 <code>Startup</code> 类构造函数可用的某些服务。 应用通过 <code>ConfigureServices</code> 添加其他服务。 然后，主机和应用服务都可以在 <code>Configure</code> 和整个应用程序中使用。</p>
<h2 id="Configure-方法"><a href="#Configure-方法" class="headerlink" title="Configure 方法"></a><a name="the-configure-method"></a>Configure 方法</h2><p>Configure 方法用于指定应用响应 HTTP 请求的方式。 可通过将中间件组件添加到 IApplicationBuilder 实例来配置请求管道。 <code>Configure</code> 方法可使用 <code>IApplicationBuilder</code>，但未在服务容器中注册。 承载创建 <code>IApplicationBuilder</code> 并将其直接传递给 <code>Configure</code>（<a href="https://github.com/aspnet/Hosting/blob/release/2.0.0/src/Microsoft.AspNetCore.Hosting/Internal/WebHost.cs#L179-L192" target="_blank" rel="external">引用源</a>）。</p>
<p>ASP.NET Core 模板配置支持开发人员异常页、<a href="http://vswebessentials.com/features/browserlink" target="_blank" rel="external">BrowserLink</a>、错误页、静态文件和 ASP.NET MVC 的管道：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (env.IsDevelopment())</div><div class="line">    &#123;</div><div class="line">        app.UseDeveloperExceptionPage();</div><div class="line">        app.UseBrowserLink();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        app.UseExceptionHandler(<span class="string">"/Error"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.UseStaticFiles();</div><div class="line"></div><div class="line">    app.UseMvc(routes =&gt;</div><div class="line">    &#123;</div><div class="line">        routes.MapRoute(</div><div class="line">            name: <span class="string">"default"</span>,</div><div class="line">            template: <span class="string">"&#123;controller&#125;/&#123;action=Index&#125;/&#123;id?&#125;"</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每个 <code>Use</code> 扩展方法将中间件组件添加到请求管道。 例如，<code>UseMvc</code> 扩展方法将路由中间件添加到请求管道，并将 MVC 配置为默认处理程序。</p>
<p>请求管道中的每个中间件组件负责调用管道中的下一个组件，或在适当情况下使链发生短路。 如果中间件链中未发生短路，则每个中间件都有第二次机会在将请求发送到客户端前处理该请求。</p>
<p>其他服务（如 <code>IHostingEnvironment</code> 和 <code>ILoggerFactory</code>），也可以在方法签名中指定。 如果指定，其他服务如果可用，将被注入。</p>
<h2 id="便利方法"><a href="#便利方法" class="headerlink" title="便利方法"></a><a name="convenience-methods"></a>便利方法</h2><p>可使用 ConfigureServices 和 Configure 便利方法，而不是指定 <code>Startup</code> 类。 多次调用 <code>ConfigureServices</code> 将追加到另一个。 多次调用 <code>Configure</code> 将使用上一个方法调用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IHostingEnvironment HostingEnvironment &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IConfiguration Configuration &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></div><div class="line">    &#123;</div><div class="line">        BuildWebHost(args).Run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHost <span class="title">BuildWebHost</span>(<span class="params"><span class="keyword">string</span>[] args</span>) </span>=&gt;</div><div class="line">        WebHost.CreateDefaultBuilder(args)</div><div class="line">            .ConfigureAppConfiguration((hostingContext, config) =&gt;</div><div class="line">            &#123;</div><div class="line">                HostingEnvironment = hostingContext.HostingEnvironment;</div><div class="line">                Configuration = config.Build();</div><div class="line">            &#125;)</div><div class="line">            .ConfigureServices(services =&gt;</div><div class="line">            &#123;</div><div class="line">                services.AddMvc();</div><div class="line">            &#125;)</div><div class="line">            .Configure(app =&gt;</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (HostingEnvironment.IsDevelopment())</div><div class="line">                &#123;</div><div class="line">                    app.UseDeveloperExceptionPage();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    app.UseExceptionHandler(<span class="string">"/Error"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Configuration is available during startup. Examples:</span></div><div class="line">                <span class="comment">// Configuration["key"]</span></div><div class="line">                <span class="comment">// Configuration["subsection:suboption1"]</span></div><div class="line"></div><div class="line">                app.UseMvcWithDefaultRoute();</div><div class="line">                app.UseStaticFiles();</div><div class="line">            &#125;)</div><div class="line">            .Build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Startup-筛选器"><a href="#Startup-筛选器" class="headerlink" title="Startup 筛选器"></a><a name="startup-filters"></a>Startup 筛选器</h2><p>在应用的 Configure 中间件管道的开头或末尾使用 IStartupFilter 来配置中间件。 <code>IStartupFilter</code> 有助于确保中间件在应用请求处理管道的开始或结束时由库添加的中间件之前或之后运行。</p>
<p><code>IStartupFilter</code> 实现单个方法（即 Configure），该方法接收并返回 <code>Action&lt;IApplicationBuilder&gt;</code>。 IApplicationBuilder 定义用于配置应用请求管道的类。</p>
<p>在请求管道中，每个 <code>IStartupFilter</code> 实现一个或多个中间件。 筛选器按照添加到服务容器的顺序调用。 筛选器可在将控件传递给下一个筛选器之前或之后添加中间件，从而附加到应用管道的开头或末尾。</p>
<p><a href="https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/startup/sample/" target="_blank" rel="external">示例应用</a>演示如何向 <code>IStartupFilter</code> 注册中间件。 示例应用包含一个中间件，该中间件从查询字符串参数中设置选项值：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RequestSetOptionsMiddleware</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate _next;</div><div class="line">    <span class="keyword">private</span> IOptions&lt;AppOptions&gt; _injectedOptions;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestSetOptionsMiddleware</span>(<span class="params"></span></span></div><div class="line">        RequestDelegate next, IOptions&lt;AppOptions&gt; injectedOptions)</div><div class="line">    &#123;</div><div class="line">        _next = next;</div><div class="line">        _injectedOptions = injectedOptions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Invoke</span>(<span class="params">HttpContext httpContext</span>)</span></div><div class="line">    &#123;</div><div class="line">        Console.WriteLine(<span class="string">"RequestSetOptionsMiddleware.Invoke"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">var</span> option = httpContext.Request.Query[<span class="string">"option"</span>];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrWhiteSpace(option))</div><div class="line">        &#123;</div><div class="line">            _injectedOptions.Value.Option = WebUtility.HtmlEncode(option);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">await</span> _next(httpContext);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>RequestSetOptionsStartupFilter</code> 类中配置 <code>RequestSetOptionsMiddleware</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RequestSetOptionsStartupFilter</span> : <span class="title">IStartupFilter</span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Action&lt;IApplicationBuilder&gt; <span class="title">Configure</span>(<span class="params">Action&lt;IApplicationBuilder&gt; next</span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> builder =&gt;</div><div class="line">        &#123;</div><div class="line">            builder.UseMiddleware&lt;RequestSetOptionsMiddleware&gt;();</div><div class="line">            next(builder);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>ConfigureServices</code> 的服务容器中注册 <code>IStartupFilter</code>：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></div><div class="line">&#123;</div><div class="line">    services.AddTransient&lt;IStartupFilter, RequestSetOptionsStartupFilter&gt;();</div><div class="line">    services.AddMvc();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当提供 <code>option</code> 的查询字符串参数时，中间件在 MVC 中间件呈现响应之前处理分配值：</p>
<p><img src="https://meowv.github.io/images/dnc/index.png" alt="浏览器窗口显示已呈现的索引页。 基于请求页面（其中查询字符串参数和选项的值设置为“From Middleware”），Option 的值呈现为“From Middleware”。"></p>
<p>中间件执行顺序由 <code>IStartupFilter</code> 注册顺序设置：</p>
<ul>
<li>多个 <code>IStartupFilter</code> 实现可能与相同的对象进行交互。 如果顺序很重要，请将它们的 <code>IStartupFilter</code> 服务注册进行排序，以匹配其中间件应有的运行顺序。</li>
<li>库可能添加包含一个或多个 <code>IStartupFilter</code> 实现的中间件，这些实现在向 <code>IStartupFilter</code> 注册的其他应用中间件之前或之后运行。 若要在库的 <code>IStartupFilter</code> 添加中间件之前调用 <code>IStartupFilter</code> 中间件，请在将库添加到服务容器之前定位服务注册。 若要在此后调用，请在添加库之后定位服务注册。</li>
</ul>
<h2 id="在启动时从外部程序集添加配置"><a href="#在启动时从外部程序集添加配置" class="headerlink" title="在启动时从外部程序集添加配置"></a><a name="adding-configuration-at-startup-from-an-external-assembly"></a>在启动时从外部程序集添加配置</h2><p>通过 IHostingStartup 实现，可在启动时从应用 <code>Startup</code> 类之外的外部程序集向应用添加增强功能。</p>
</div><iframe src="/v2/donate/?AliPayQR=/img/AliPayQR.png&amp;WeChatQR=/img/AliPayQR.png&amp;GitHub=https://github.com/Meowv&amp;BTCQR=undefined&amp;BTCKEY=undefined&amp;PayPal=undefined" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"><a href="/v2/tags/NET/">.NET</a><a href="/v2/tags/ASP-NET/">.ASP.NET</a><a href="/v2/tags/NET-Core/">.NET Core</a><a href="/v2/tags/ASP-NET-Core/">.ASP.NET Core</a></div><div class="post-nav"><a href="/v2/2018/07/03/asp.net-fundamentals-dependency-injection/" class="pre">在 ASP.NET Core 依赖注入</a><a href="/v2/2018/07/03/asp.net-fundamentals/" class="next">ASP.NET Core 基础知识</a></div><div id="container"></div><link rel="stylesheet" href="/v2/css/default.css?v=1.0.0"><script src="/v2/js/gitment.browser.js?v=1.0.0"></script><script>var gitment = new Gitment({
  owner: 'Meowv',
  repo: 'meowv.github.io',
  oauth: {
    client_id: '8b9d5a517ebad5add0cc',
    client_secret: '61ca179ff1d9c8aedd440e95521efd7240453d8b',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://xj8c.cc/v2"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/v2/tags/post/" style="font-size: 15px;">post</a> <a href="/v2/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/v2/tags/诗文/" style="font-size: 15px;">诗文</a> <a href="/v2/tags/CEAC/" style="font-size: 15px;">CEAC</a> <a href="/v2/tags/office2010/" style="font-size: 15px;">office2010</a> <a href="/v2/tags/绿色软件/" style="font-size: 15px;">绿色软件</a> <a href="/v2/tags/HtmlAgilityPack/" style="font-size: 15px;">HtmlAgilityPack</a> <a href="/v2/tags/爬虫/" style="font-size: 15px;">爬虫</a> <a href="/v2/tags/ReactNative/" style="font-size: 15px;">ReactNative</a> <a href="/v2/tags/Regex/" style="font-size: 15px;">Regex</a> <a href="/v2/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/v2/tags/SqlServer/" style="font-size: 15px;">SqlServer</a> <a href="/v2/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/v2/tags/今日头条/" style="font-size: 15px;">今日头条</a> <a href="/v2/tags/Newtonsoft-Json/" style="font-size: 15px;">Newtonsoft.Json</a> <a href="/v2/tags/春天/" style="font-size: 15px;">春天</a> <a href="/v2/tags/Photoshop/" style="font-size: 15px;">Photoshop</a> <a href="/v2/tags/NET/" style="font-size: 15px;">.NET</a> <a href="/v2/tags/ASP-NET/" style="font-size: 15px;">.ASP.NET</a> <a href="/v2/tags/NET-Core/" style="font-size: 15px;">.NET Core</a> <a href="/v2/tags/ASP-NET-Core/" style="font-size: 15px;">.ASP.NET Core</a> <a href="/v2/tags/ASP-NET/" style="font-size: 15px;">ASP.NET</a> <a href="/v2/tags/面试/" style="font-size: 15px;">面试</a> <a href="/v2/tags/技术教程/" style="font-size: 15px;">技术教程</a> <a href="/v2/tags/软件测试/" style="font-size: 15px;">软件测试</a> <a href="/v2/tags/互联网/" style="font-size: 15px;">互联网</a> <a href="/v2/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/v2/tags/C/" style="font-size: 15px;">C#</a> <a href="/v2/tags/get/" style="font-size: 15px;">get</a> <a href="/v2/tags/年终总结/" style="font-size: 15px;">年终总结</a> <a href="/v2/tags/毕业答辩/" style="font-size: 15px;">毕业答辩</a> <a href="/v2/tags/实习感受/" style="font-size: 15px;">实习感受</a> <a href="/v2/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/v2/tags/计算机一级/" style="font-size: 15px;">计算机一级</a> <a href="/v2/tags/IT/" style="font-size: 15px;">IT</a> <a href="/v2/tags/编程/" style="font-size: 15px;">编程</a> <a href="/v2/tags/逆袭/" style="font-size: 15px;">逆袭</a> <a href="/v2/tags/Visual-Studio/" style="font-size: 15px;">Visual Studio</a> <a href="/v2/tags/三层架构/" style="font-size: 15px;">三层架构</a> <a href="/v2/tags/琅琊榜/" style="font-size: 15px;">琅琊榜</a> <a href="/v2/tags/手机/" style="font-size: 15px;">手机</a> <a href="/v2/tags/win7/" style="font-size: 15px;">win7</a> <a href="/v2/tags/命令行/" style="font-size: 15px;">命令行</a> <a href="/v2/tags/快捷键/" style="font-size: 15px;">快捷键</a> <a href="/v2/tags/win10/" style="font-size: 15px;">win10</a> <a href="/v2/tags/原版系统/" style="font-size: 15px;">原版系统</a> <a href="/v2/tags/xml/" style="font-size: 15px;">xml</a> <a href="/v2/tags/黑客/" style="font-size: 15px;">黑客</a> <a href="/v2/tags/电影/" style="font-size: 15px;">电影</a> <a href="/v2/tags/微软/" style="font-size: 15px;">微软</a> <a href="/v2/tags/计算机基础/" style="font-size: 15px;">计算机基础</a> <a href="/v2/tags/进制转换/" style="font-size: 15px;">进制转换</a> <a href="/v2/tags/Python/" style="font-size: 15px;">Python</a> <a href="/v2/tags/入门教程/" style="font-size: 15px;">入门教程</a> <a href="/v2/tags/知乎/" style="font-size: 15px;">知乎</a> <a href="/v2/tags/小说/" style="font-size: 15px;">小说</a> <a href="/v2/tags/程序员/" style="font-size: 15px;">程序员</a> <a href="/v2/tags/实习/" style="font-size: 15px;">实习</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/v2/2018/07/03/asp.net-fundamentals-dependency-injection/">在 ASP.NET Core 依赖注入</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2018/07/03/asp.net-fundamentals-startup/">ASP.NET Core 中的应用程序启动</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2018/07/03/asp.net-fundamentals/">ASP.NET Core 基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2018/07/02/asp.net-core-getting-started/">ASP.NET Core 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2018/07/02/asp.net-core-introduce/">ASP.NET Core 简单介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2018/07/02/dotnet-core-introduce/">.NET Core 简单介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2018/01/02/2017-year-end-summary/">2017年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2017/12/07/linux-cmd-list/">Linux 命令行一览</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2017/12/06/python-tutorial/">Python入门教程</a></li><li class="post-list-item"><a class="post-list-link" href="/v2/2017/10/13/Regex-chinese-english-comparison-table/">正则表达式术语中英文对照表</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://meowv.com/" title="喵呜网" target="_blank">喵呜网</a><ul></ul><a href="http://v.xj8c.cc/" title="VIP电影在线播放" target="_blank">VIP电影在线播放</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2015 - 2018 <a href="/v2/." rel="nofollow">当然我在瞎扯.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/v2/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/v2/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/v2/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/v2/js/smartresize.js?v=1.0.0"></script></div></body></html>